from scipy.spatial.transform import Rotation as R
import pybullet as p

def ur5_debug_parameter(env):
        for _ in range(50):
            env.move_human_arm([3.1, 1.57, -1.57, 0])
            env.bc.stepSimulation()

        pos = env.bc.getLinkState(env.humanoid._humanoid, env.right_elbow)[0]
        pos_up = (pos[0], pos[1]+0.2, pos[2])
        print(pos)

        position_control_group = []
        position_control_group.append(env.bc.addUserDebugParameter('x', -1.5, 1.5, pos_up[0]))
        position_control_group.append(env.bc.addUserDebugParameter('y', -1.5, 1.5, pos_up[1]))
        position_control_group.append(env.bc.addUserDebugParameter('z', -1.5, 1.5, pos_up[2]))
        position_control_group.append(env.bc.addUserDebugParameter('roll', -3.14, 3.14, 3.14))
        position_control_group.append(env.bc.addUserDebugParameter('pitch', -3.14, 3.14, 0))
        position_control_group.append(env.bc.addUserDebugParameter('yaw', -3.14, 3.14, -1.57))
        position_control_group.append(env.bc.addUserDebugParameter('gripper_opening', 0, 0.085, 0.08))

        while True:
            env.bc.configureDebugVisualizer(p.COV_ENABLE_SINGLE_STEP_RENDERING) 

            parameter = []
            for i in range(len(position_control_group)):
                parameter.append(env.bc.readUserDebugParameter(position_control_group[i]))

            env.robot.move_ee(action=parameter[:-1], control_method='end')
            env.robot.move_gripper(parameter[-1])

            # env.move_human_arm([2.7, 1.4, -1.9, 0])

            env.bc.stepSimulation()

            # for i, joint_id in enumerate(env.robot.arm_controllable_joints):
            #     print(i, env.bc.getJointState(env.robot.id, joint_id)[0])

            # right_arm = []
            # right_arm.append(env.bc.getJointState(env.humanoid._humanoid, env.right_shoulder_y)[0])
            # right_arm.append(env.bc.getJointState(env.humanoid._humanoid, env.right_shoulder_p)[0])
            # right_arm.append(env.bc.getJointState(env.humanoid._humanoid, env.right_shoulder_r)[0])
            # right_arm.append(env.bc.getJointState(env.humanoid._humanoid, env.right_elbow)[0])
            # print(right_arm)


def draw_frame(env, position, quaternion=[0, 0, 0, 1]):
        m = R.from_quat(quaternion).as_matrix()
        x_vec = m[:, 0]
        colors = [[1, 0, 0], [0, 1, 0], [0, 0, 1]]

        for color, column in zip(colors, range(3)):
            vec = m[:, column]
            from_p = position
            to_p = position + (vec * 0.1)
            env.bc.addUserDebugLine(from_p, to_p, color, lineWidth=3, lifeTime=0)

def draw_control_points(env):
    q = [-3.1427, -1.7982,  1.2290, -0.9127, -0.0133,  1.4311]
    control_points = [[0.5000, 0.7000, 0.0892],
         [0.4999, 0.6450, 0.0892],
         [0.5001, 0.7550, 0.0892],
         [0.5550, 0.6999, 0.0892],
         [0.4998, 0.5642, 0.0892],
         [0.4998, 0.5092, 0.0892],
         [0.4999, 0.6192, 0.0892],
         [0.5958, 0.6837, 0.5032],
         [0.6380, 0.7237, 0.4763],
         [0.6379, 0.6437, 0.4763],
         [0.5537, 0.7238, 0.5302],
         [0.5536, 0.6438, 0.5302],
         [0.2654, 0.6841, 0.7146],
         [0.2953, 0.6841, 0.7173],
         [0.2106, 0.6842, 0.7097],
         [0.2627, 0.6841, 0.7445],
         [0.2653, 0.5911, 0.7146],
         [0.2626, 0.5907, 0.7445],
         [0.2680, 0.5915, 0.6847],
         [0.3201, 0.5910, 0.7195],
         [0.1710, 0.5912, 0.7062],
         [0.2010, 0.5912, 0.7047],
         [0.1411, 0.5912, 0.7077],
         [0.1695, 0.5916, 0.6763],
         [0.2010, 0.6412, 0.7054],
         [0.1410, 0.6412, 0.7084],
         [0.1695, 0.6416, 0.6769],
         [0.1710, 0.5089, 0.7051],
         [0.1710, 0.3889, 0.7035],
         [0.1411, 0.5089, 0.7066],
         [0.2010, 0.5089, 0.7036],
         [0.1725, 0.5085, 0.7351],
         [0.1695, 0.5093, 0.6752],
         [0.1161, 0.4539, 0.7072],
         [0.2260, 0.4540, 0.7016],
         [0.1161, 0.3889, 0.7063],
         [0.2260, 0.3890, 0.7007],
         [0.1734, 0.4139, 0.7355],
         [0.1727, 0.4153, 0.7186],
         [0.1719, 0.4168, 0.7017],
         [0.1711, 0.4182, 0.6848],
         [0.1704, 0.4196, 0.6679],
         [0.1696, 0.4211, 0.6510],
         [0.1688, 0.4225, 0.6341],
         [0.1681, 0.4239, 0.6172],
         [0.1984, 0.4040, 0.7335],
         [0.1976, 0.4054, 0.7166],
         [0.1969, 0.4068, 0.6997],
         [0.1961, 0.4083, 0.6828],
         [0.1953, 0.4097, 0.6659],
         [0.1946, 0.4111, 0.6490],
         [0.1938, 0.4126, 0.6321],
         [0.1930, 0.4140, 0.6153],
         [0.2090, 0.3793, 0.7309],
         [0.2082, 0.3808, 0.7140],
         [0.2074, 0.3822, 0.6972],
         [0.2067, 0.3836, 0.6803],
         [0.2059, 0.3851, 0.6634],
         [0.2051, 0.3865, 0.6465],
         [0.2044, 0.3879, 0.6296],
         [0.2036, 0.3893, 0.6127],
         [0.1989, 0.3544, 0.7293],
         [0.1981, 0.3558, 0.7124],
         [0.1974, 0.3573, 0.6955],
         [0.1966, 0.3587, 0.6786],
         [0.1958, 0.3601, 0.6617],
         [0.1951, 0.3615, 0.6448],
         [0.1943, 0.3630, 0.6279],
         [0.1935, 0.3644, 0.6110],
         [0.1742, 0.3438, 0.7295],
         [0.1734, 0.3452, 0.7126],
         [0.1726, 0.3466, 0.6957],
         [0.1719, 0.3481, 0.6788],
         [0.1711, 0.3495, 0.6619],
         [0.1703, 0.3509, 0.6450],
         [0.1696, 0.3524, 0.6281],
         [0.1688, 0.3538, 0.6113],
         [0.1492, 0.3537, 0.7315],
         [0.1484, 0.3551, 0.7146],
         [0.1477, 0.3566, 0.6977],
         [0.1469, 0.3580, 0.6808],
         [0.1461, 0.3594, 0.6639],
         [0.1454, 0.3608, 0.6470],
         [0.1446, 0.3623, 0.6301],
         [0.1438, 0.3637, 0.6132],
         [0.1386, 0.3783, 0.7341],
         [0.1379, 0.3798, 0.7172],
         [0.1371, 0.3812, 0.7003],
         [0.1363, 0.3826, 0.6834],
         [0.1356, 0.3841, 0.6665],
         [0.1348, 0.3855, 0.6496],
         [0.1340, 0.3869, 0.6327],
         [0.1333, 0.3884, 0.6158],
         [0.1487, 0.4033, 0.7357],
         [0.1479, 0.4047, 0.7188],
         [0.1471, 0.4062, 0.7019],
         [0.1464, 0.4076, 0.6850],
         [0.1456, 0.4090, 0.6681],
         [0.1448, 0.4104, 0.6512],
         [0.1441, 0.4119, 0.6343],
         [0.1433, 0.4133, 0.6175],
         [0.1734, 0.4139, 0.7355],
         [0.1727, 0.4153, 0.7186],
         [0.1719, 0.4168, 0.7017],
         [0.1711, 0.4182, 0.6848],
         [0.1704, 0.4196, 0.6679],
         [0.1696, 0.4211, 0.6510],
         [0.1688, 0.4225, 0.6341],
         [0.1681, 0.4239, 0.6172],
         [0.1668, 0.3918, 0.5792],
         [0.1671, 0.4158, 0.5916],
         [0.1681, 0.4239, 0.6172],
         [0.1693, 0.4116, 0.6411],
         [0.1700, 0.3859, 0.6493],
         [0.1668, 0.3918, 0.5792],
         [0.1847, 0.4087, 0.5902],
         [0.1930, 0.4140, 0.6153],
         [0.1870, 0.4045, 0.6397],
         [0.1700, 0.3859, 0.6493],
         [0.1668, 0.3918, 0.5792],
         [0.1922, 0.3913, 0.5884],
         [0.2036, 0.3893, 0.6127],
         [0.1944, 0.3871, 0.6379],
         [0.1700, 0.3859, 0.6493],
         [0.1668, 0.3918, 0.5792],
         [0.1851, 0.3737, 0.5872],
         [0.1935, 0.3644, 0.6110],
         [0.1873, 0.3695, 0.6367],
         [0.1700, 0.3859, 0.6493],
         [0.1668, 0.3918, 0.5792],
         [0.1676, 0.3662, 0.5874],
         [0.1688, 0.3538, 0.6113],
         [0.1698, 0.3620, 0.6369],
         [0.1700, 0.3859, 0.6493],
         [0.1668, 0.3918, 0.5792],
         [0.1499, 0.3732, 0.5887],
         [0.1438, 0.3637, 0.6132],
         [0.1522, 0.3690, 0.6383],
         [0.1700, 0.3859, 0.6493],
         [0.1668, 0.3918, 0.5792],
         [0.1424, 0.3906, 0.5906],
         [0.1333, 0.3884, 0.6158],
         [0.1447, 0.3864, 0.6401],
         [0.1700, 0.3859, 0.6493],
         [0.1668, 0.3918, 0.5792],
         [0.1495, 0.4082, 0.5917],
         [0.1433, 0.4133, 0.6175],
         [0.1518, 0.4040, 0.6413],
         [0.1700, 0.3859, 0.6493],
         [0.1668, 0.3918, 0.5792],
         [0.1671, 0.4158, 0.5916],
         [0.1681, 0.4239, 0.6172],
         [0.1693, 0.4116, 0.6411],
         [0.1700, 0.3859, 0.6493],
         [0.1754, 0.3759, 0.7675],
         [0.1747, 0.4015, 0.7594],
         [0.1734, 0.4139, 0.7355],
         [0.1724, 0.4057, 0.7098],
         [0.1722, 0.3818, 0.6975],
         [0.1754, 0.3759, 0.7675],
         [0.1923, 0.3945, 0.7580],
         [0.1984, 0.4040, 0.7335],
         [0.1901, 0.3987, 0.7084],
         [0.1722, 0.3818, 0.6975],
         [0.1754, 0.3759, 0.7675],
         [0.1998, 0.3771, 0.7562],
         [0.2090, 0.3793, 0.7309],
         [0.1975, 0.3813, 0.7066],
         [0.1722, 0.3818, 0.6975],
         [0.1754, 0.3759, 0.7675],
         [0.1927, 0.3595, 0.7550],
         [0.1989, 0.3544, 0.7293],
         [0.1904, 0.3636, 0.7055],
         [0.1722, 0.3818, 0.6975],
         [0.1754, 0.3759, 0.7675],
         [0.1752, 0.3519, 0.7552],
         [0.1742, 0.3438, 0.7295],
         [0.1729, 0.3561, 0.7056],
         [0.1722, 0.3818, 0.6975],
         [0.1754, 0.3759, 0.7675],
         [0.1575, 0.3590, 0.7566],
         [0.1492, 0.3537, 0.7315],
         [0.1553, 0.3632, 0.7070],
         [0.1722, 0.3818, 0.6975],
         [0.1754, 0.3759, 0.7675],
         [0.1501, 0.3764, 0.7584],
         [0.1386, 0.3783, 0.7341],
         [0.1478, 0.3806, 0.7088],
         [0.1722, 0.3818, 0.6975],
         [0.1754, 0.3759, 0.7675],
         [0.1572, 0.3940, 0.7595],
         [0.1487, 0.4033, 0.7357],
         [0.1549, 0.3982, 0.7100],
         [0.1722, 0.3818, 0.6975],
         [0.1754, 0.3759, 0.7675],
         [0.1747, 0.4015, 0.7594],
         [0.1734, 0.4139, 0.7355],
         [0.1724, 0.4057, 0.7098],
         [0.1722, 0.3818, 0.6975],
         [0.1415, 0.3731, 0.7966],
         [0.1440, 0.3865, 0.7977],
         [0.1515, 0.3980, 0.7983],
         [0.1629, 0.4058, 0.7984],
         [0.1763, 0.4086, 0.7981],
         [0.1898, 0.4061, 0.7972],
         [0.2012, 0.3987, 0.7961],
         [0.2090, 0.3874, 0.7948],
         [0.2118, 0.3740, 0.7935],
         [0.1415, 0.3731, 0.7966],
         [0.1436, 0.3834, 0.7878],
         [0.1508, 0.3922, 0.7802],
         [0.1619, 0.3982, 0.7747],
         [0.1753, 0.4004, 0.7724],
         [0.1888, 0.3986, 0.7735],
         [0.2005, 0.3929, 0.7780],
         [0.2086, 0.3843, 0.7850],
         [0.2118, 0.3740, 0.7935],
         [0.1415, 0.3731, 0.7966],
         [0.1435, 0.3742, 0.7831],
         [0.1507, 0.3753, 0.7714],
         [0.1617, 0.3761, 0.7633],
         [0.1750, 0.3765, 0.7600],
         [0.1886, 0.3765, 0.7621],
         [0.2004, 0.3760, 0.7692],
         [0.2085, 0.3751, 0.7802],
         [0.2118, 0.3740, 0.7935],
         [0.1415, 0.3731, 0.7966],
         [0.1438, 0.3644, 0.7862],
         [0.1512, 0.3571, 0.7772],
         [0.1624, 0.3524, 0.7708],
         [0.1758, 0.3508, 0.7682],
         [0.1893, 0.3528, 0.7696],
         [0.2009, 0.3578, 0.7750],
         [0.2088, 0.3653, 0.7834],
         [0.2118, 0.3740, 0.7935],
         [0.1415, 0.3731, 0.7966],
         [0.1443, 0.3597, 0.7954],
         [0.1520, 0.3484, 0.7941],
         [0.1635, 0.3410, 0.7929],
         [0.1770, 0.3385, 0.7921],
         [0.1904, 0.3413, 0.7917],
         [0.2018, 0.3491, 0.7919],
         [0.2093, 0.3606, 0.7925],
         [0.2118, 0.3740, 0.7935],
         [0.1415, 0.3731, 0.7966],
         [0.1447, 0.3628, 0.8052],
         [0.1527, 0.3542, 0.8122],
         [0.1645, 0.3485, 0.8166],
         [0.1780, 0.3466, 0.8177],
         [0.1914, 0.3489, 0.8154],
         [0.2025, 0.3549, 0.8100],
         [0.2097, 0.3637, 0.8023],
         [0.2118, 0.3740, 0.7935],
         [0.1415, 0.3731, 0.7966],
         [0.1448, 0.3720, 0.8099],
         [0.1529, 0.3711, 0.8210],
         [0.1647, 0.3706, 0.8280],
         [0.1782, 0.3706, 0.8301],
         [0.1916, 0.3710, 0.8269],
         [0.2026, 0.3718, 0.8188],
         [0.2097, 0.3729, 0.8071],
         [0.2118, 0.3740, 0.7935],
         [0.1415, 0.3731, 0.7966],
         [0.1445, 0.3818, 0.8068],
         [0.1524, 0.3892, 0.8152],
         [0.1640, 0.3943, 0.8205],
         [0.1775, 0.3962, 0.8220],
         [0.1909, 0.3947, 0.8193],
         [0.2021, 0.3899, 0.8130],
         [0.2095, 0.3827, 0.8039],
         [0.2118, 0.3740, 0.7935],
         [0.1415, 0.3731, 0.7966],
         [0.1440, 0.3865, 0.7977],
         [0.1515, 0.3980, 0.7983],
         [0.1629, 0.4058, 0.7984],
         [0.1763, 0.4086, 0.7981],
         [0.1898, 0.4061, 0.7972],
         [0.2012, 0.3987, 0.7961],
         [0.2090, 0.3874, 0.7948],
         [0.2118, 0.3740, 0.7935]]
    
    env.reset_robot(env.robot, q)
    for control_point in control_points:
        env.draw_sphere_marker(position=control_point, radius=0.02)

    print('done')

def draw_control_points_from_pcd(env, pcd):
    for control_point in pcd:
        env.draw_sphere_marker(position=control_point, radius=0.02)

    print('done')